'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FunctionsRouter = undefined;

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _middlewares = require('../middlewares');

var _StatusHandler = require('../StatusHandler');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('../logger');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// FunctionsRouter.js

var Parse = require('parse/node').Parse,
    triggers = require('../triggers');

function parseObject(obj) {
  if (Array.isArray(obj)) {
    return obj.map(item => {
      return parseObject(item);
    });
  } else if (obj && obj.__type == 'Date') {
    return Object.assign(new Date(obj.iso), obj);
  } else if (obj && obj.__type == 'File') {
    return Parse.File.fromJSON(obj);
  } else if (obj && typeof obj === 'object') {
    return parseParams(obj);
  } else {
    return obj;
  }
}

function parseParams(params) {
  return _lodash2.default.mapValues(params, parseObject);
}

class FunctionsRouter extends _PromiseRouter2.default {

  mountRoutes() {
    this.route('POST', '/functions/:functionName', FunctionsRouter.handleCloudFunction);
    this.route('POST', '/jobs/:jobName', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
    this.route('POST', '/jobs', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
  }

  static handleCloudJob(req) {
    const jobName = req.params.jobName || req.body.jobName;
    const applicationId = req.config.applicationId;
    const jobHandler = (0, _StatusHandler.jobStatusHandler)(req.config);
    const jobFunction = triggers.getJob(jobName, applicationId);
    if (!jobFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, 'Invalid job.');
    }
    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      jobName,
      message: jobHandler.setMessage.bind(jobHandler)
    };

    return jobHandler.setRunning(jobName, params).then(jobStatus => {
      request.jobId = jobStatus.objectId;
      // run the function async
      process.nextTick(() => {
        Promise.resolve().then(() => {
          return jobFunction(request);
        }).then(result => {
          jobHandler.setSucceeded(result);
        }, error => {
          jobHandler.setFailed(error);
        });
      });
      return {
        headers: {
          'X-Parse-Job-Status-Id': jobStatus.objectId
        },
        response: {}
      };
    });
  }

  static createResponseObject(resolve, reject, message) {
    return {
      success: function (result) {
        resolve({
          response: {
            result: Parse._encode(result)
          }
        });
      },
      error: function (message) {
        // parse error, process away
        if (message instanceof Parse.Error) {
          return reject(message);
        }

        const code = Parse.Error.SCRIPT_FAILED;
        // If it's an error, mark it as a script failed
        if (typeof message === 'string') {
          return reject(new Parse.Error(code, message));
        }
        if (message instanceof Error) {
          message = message.message;
        }
        reject(new Parse.Error(code, message));
      },
      message: message
    };
  }

  static handleCloudFunction(req) {
    const functionName = req.params.functionName;
    const applicationId = req.config.applicationId;
    const theFunction = triggers.getFunction(functionName, applicationId);
    const theValidator = triggers.getValidator(req.params.functionName, applicationId);
    if (!theFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, `Invalid function: "${functionName}"`);
    }
    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      master: req.auth && req.auth.isMaster,
      user: req.auth && req.auth.user,
      installationId: req.info.installationId,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      functionName
    };

    if (theValidator && typeof theValidator === "function") {
      var result = theValidator(request);
      if (!result) {
        throw new Parse.Error(Parse.Error.VALIDATION_ERROR, 'Validation failed.');
      }
    }

    return new Promise(function (resolve, reject) {
      const userString = req.auth && req.auth.user ? req.auth.user.id : undefined;
      const cleanInput = _logger.logger.truncateLogMessage(JSON.stringify(params));
      const { success, error, message } = FunctionsRouter.createResponseObject(result => {
        try {
          const cleanResult = _logger.logger.truncateLogMessage(JSON.stringify(result.response.result));
          _logger.logger.info(`Ran cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Result: ${cleanResult}`, {
            functionName,
            params,
            user: userString
          });
          resolve(result);
        } catch (e) {
          reject(e);
        }
      }, error => {
        try {
          _logger.logger.error(`Failed running cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Error: ` + JSON.stringify(error), {
            functionName,
            error,
            params,
            user: userString
          });
          reject(error);
        } catch (e) {
          reject(e);
        }
      });
      return Promise.resolve().then(() => {
        return theFunction(request, { message });
      }).then(success, error);
    });
  }
}
exports.FunctionsRouter = FunctionsRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0Z1bmN0aW9uc1JvdXRlci5qcyJdLCJuYW1lcyI6WyJQYXJzZSIsInJlcXVpcmUiLCJ0cmlnZ2VycyIsInBhcnNlT2JqZWN0Iiwib2JqIiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXRlbSIsIl9fdHlwZSIsIk9iamVjdCIsImFzc2lnbiIsIkRhdGUiLCJpc28iLCJGaWxlIiwiZnJvbUpTT04iLCJwYXJzZVBhcmFtcyIsInBhcmFtcyIsIl8iLCJtYXBWYWx1ZXMiLCJGdW5jdGlvbnNSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwibW91bnRSb3V0ZXMiLCJyb3V0ZSIsImhhbmRsZUNsb3VkRnVuY3Rpb24iLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyIsInJlcSIsImhhbmRsZUNsb3VkSm9iIiwiam9iTmFtZSIsImJvZHkiLCJhcHBsaWNhdGlvbklkIiwiY29uZmlnIiwiam9iSGFuZGxlciIsImpvYkZ1bmN0aW9uIiwiZ2V0Sm9iIiwiRXJyb3IiLCJTQ1JJUFRfRkFJTEVEIiwicXVlcnkiLCJyZXF1ZXN0IiwibG9nIiwibG9nZ2VyQ29udHJvbGxlciIsImhlYWRlcnMiLCJpcCIsIm1lc3NhZ2UiLCJzZXRNZXNzYWdlIiwiYmluZCIsInNldFJ1bm5pbmciLCJ0aGVuIiwiam9iU3RhdHVzIiwiam9iSWQiLCJvYmplY3RJZCIsInByb2Nlc3MiLCJuZXh0VGljayIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVzdWx0Iiwic2V0U3VjY2VlZGVkIiwiZXJyb3IiLCJzZXRGYWlsZWQiLCJyZXNwb25zZSIsImNyZWF0ZVJlc3BvbnNlT2JqZWN0IiwicmVqZWN0Iiwic3VjY2VzcyIsIl9lbmNvZGUiLCJjb2RlIiwiZnVuY3Rpb25OYW1lIiwidGhlRnVuY3Rpb24iLCJnZXRGdW5jdGlvbiIsInRoZVZhbGlkYXRvciIsImdldFZhbGlkYXRvciIsIm1hc3RlciIsImF1dGgiLCJpc01hc3RlciIsInVzZXIiLCJpbnN0YWxsYXRpb25JZCIsImluZm8iLCJWQUxJREFUSU9OX0VSUk9SIiwidXNlclN0cmluZyIsImlkIiwidW5kZWZpbmVkIiwiY2xlYW5JbnB1dCIsImxvZ2dlciIsInRydW5jYXRlTG9nTWVzc2FnZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjbGVhblJlc3VsdCIsImUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFUQTs7QUFFQSxJQUFJQSxRQUFRQyxRQUFRLFlBQVIsRUFBc0JELEtBQWxDO0FBQUEsSUFDRUUsV0FBV0QsUUFBUSxhQUFSLENBRGI7O0FBU0EsU0FBU0UsV0FBVCxDQUFxQkMsR0FBckIsRUFBMEI7QUFDeEIsTUFBSUMsTUFBTUMsT0FBTixDQUFjRixHQUFkLENBQUosRUFBd0I7QUFDdEIsV0FBT0EsSUFBSUcsR0FBSixDQUFTQyxJQUFELElBQVU7QUFDdkIsYUFBT0wsWUFBWUssSUFBWixDQUFQO0FBQ0QsS0FGTSxDQUFQO0FBR0QsR0FKRCxNQUlPLElBQUlKLE9BQU9BLElBQUlLLE1BQUosSUFBYyxNQUF6QixFQUFpQztBQUN0QyxXQUFPQyxPQUFPQyxNQUFQLENBQWMsSUFBSUMsSUFBSixDQUFTUixJQUFJUyxHQUFiLENBQWQsRUFBaUNULEdBQWpDLENBQVA7QUFDRCxHQUZNLE1BRUEsSUFBSUEsT0FBT0EsSUFBSUssTUFBSixJQUFjLE1BQXpCLEVBQWlDO0FBQ3RDLFdBQU9ULE1BQU1jLElBQU4sQ0FBV0MsUUFBWCxDQUFvQlgsR0FBcEIsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJQSxPQUFPLE9BQU9BLEdBQVAsS0FBZSxRQUExQixFQUFvQztBQUN6QyxXQUFPWSxZQUFZWixHQUFaLENBQVA7QUFDRCxHQUZNLE1BRUE7QUFDTCxXQUFPQSxHQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTWSxXQUFULENBQXFCQyxNQUFyQixFQUE2QjtBQUMzQixTQUFPQyxpQkFBRUMsU0FBRixDQUFZRixNQUFaLEVBQW9CZCxXQUFwQixDQUFQO0FBQ0Q7O0FBRU0s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L0IsQ0FBMUIsQ0FBcEI7QUFDQTBCLHlCQUFPTixJQUFQLENBQ0csc0JBQXFCVixZQUFhLGFBQVlZLFVBQVcsb0JBQW1CRyxVQUFZLGVBQWNLLFdBQWEsRUFEdEgsRUFFRTtBQUNFcEIsd0JBREY7QUFFRWhELGtCQUZGO0FBR0V3RCxrQkFBTUk7QUFIUixXQUZGO0FBUUF2QixrQkFBUUMsTUFBUjtBQUNELFNBWEQsQ0FXRSxPQUFPK0IsQ0FBUCxFQUFVO0FBQ1Z6QixpQkFBT3lCLENBQVA7QUFDRDtBQUNGLE9BZm1DLEVBZWhDN0IsS0FBRCxJQUFXO0FBQ1osWUFBSTtBQUNGd0IseUJBQU94QixLQUFQLENBQ0csaUNBQWdDUSxZQUFhLGFBQVlZLFVBQVcsb0JBQW1CRyxVQUFXLGFBQW5HLEdBQWtIRyxLQUFLQyxTQUFMLENBQWUzQixLQUFmLENBRHBILEVBRUU7QUFDRVEsd0JBREY7QUFFRVIsaUJBRkY7QUFHRXhDLGtCQUhGO0FBSUV3RCxrQkFBTUk7QUFKUixXQUZGO0FBU0FoQixpQkFBT0osS0FBUDtBQUNELFNBWEQsQ0FXRSxPQUFPNkIsQ0FBUCxFQUFVO0FBQ1Z6QixpQkFBT3lCLENBQVA7QUFDRDtBQUNGLE9BOUJtQyxDQUFwQztBQStCQSxhQUFPakMsUUFBUUMsT0FBUixHQUFrQlAsSUFBbEIsQ0FBdUIsTUFBTTtBQUNsQyxlQUFPbUIsWUFBWTVCLE9BQVosRUFBcUIsRUFBRUssT0FBRixFQUFyQixDQUFQO0FBQ0QsT0FGTSxFQUVKSSxJQUZJLENBRUNlLE9BRkQsRUFFVUwsS0FGVixDQUFQO0FBR0QsS0FyQ00sQ0FBUDtBQXNDRDtBQW5KZ0Q7UUFBdENyQyxlLEdBQUFBLGUiLCJmaWxlIjoiRnVuY3Rpb25zUm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRnVuY3Rpb25zUm91dGVyLmpzXG5cbnZhciBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZSxcbiAgdHJpZ2dlcnMgPSByZXF1aXJlKCcuLi90cmlnZ2VycycpO1xuXG5pbXBvcnQgUHJvbWlzZVJvdXRlciBmcm9tICcuLi9Qcm9taXNlUm91dGVyJztcbmltcG9ydCB7IHByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzIH0gZnJvbSAnLi4vbWlkZGxld2FyZXMnO1xuaW1wb3J0IHsgam9iU3RhdHVzSGFuZGxlciB9IGZyb20gJy4uL1N0YXR1c0hhbmRsZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XG5cbmZ1bmN0aW9uIHBhcnNlT2JqZWN0KG9iaikge1xuICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7XG4gICAgcmV0dXJuIG9iai5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBwYXJzZU9iamVjdChpdGVtKTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRGF0ZScpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgRGF0ZShvYmouaXNvKSwgb2JqKTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRmlsZScpIHtcbiAgICByZXR1cm4gUGFyc2UuRmlsZS5mcm9tSlNPTihvYmopO1xuICB9IGVsc2UgaWYgKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jykge1xuICAgIHJldHVybiBwYXJzZVBhcmFtcyhvYmopO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBvYmo7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VQYXJhbXMocGFyYW1zKSB7XG4gIHJldHVybiBfLm1hcFZhbHVlcyhwYXJhbXMsIHBhcnNlT2JqZWN0KTtcbn1cblxuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uc1JvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL2Z1bmN0aW9ucy86ZnVuY3Rpb25OYW1lJywgRnVuY3Rpb25zUm91dGVyLmhhbmRsZUNsb3VkRnVuY3Rpb24pO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL2pvYnMvOmpvYk5hbWUnLCBwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgZnVuY3Rpb24ocmVxKSB7XG4gICAgICByZXR1cm4gRnVuY3Rpb25zUm91dGVyLmhhbmRsZUNsb3VkSm9iKHJlcSk7XG4gICAgfSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvam9icycsIHByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBmdW5jdGlvbihyZXEpIHtcbiAgICAgIHJldHVybiBGdW5jdGlvbnNSb3V0ZXIuaGFuZGxlQ2xvdWRKb2IocmVxKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXRpYyBoYW5kbGVDbG91ZEpvYihyZXEpIHtcbiAgICBjb25zdCBqb2JOYW1lID0gcmVxLnBhcmFtcy5qb2JOYW1lIHx8IHJlcS5ib2R5LmpvYk5hbWU7XG4gICAgY29uc3QgYXBwbGljYXRpb25JZCA9IHJlcS5jb25maWcuYXBwbGljYXRpb25JZDtcbiAgICBjb25zdCBqb2JIYW5kbGVyID0gam9iU3RhdHVzSGFuZGxlcihyZXEuY29uZmlnKTtcbiAgICBjb25zdCBqb2JGdW5jdGlvbiA9IHRyaWdnZXJzLmdldEpvYihqb2JOYW1lLCBhcHBsaWNhdGlvbklkKTtcbiAgICBpZiAoIWpvYkZ1bmN0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuU0NSSVBUX0ZBSUxFRCwgJ0ludmFsaWQgam9iLicpO1xuICAgIH1cbiAgICBsZXQgcGFyYW1zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxLmJvZHksIHJlcS5xdWVyeSk7XG4gICAgcGFyYW1zID0gcGFyc2VQYXJhbXMocGFyYW1zKTtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgcGFyYW1zOiBwYXJhbXMsXG4gICAgICBsb2c6IHJlcS5jb25maWcubG9nZ2VyQ29udHJvbGxlcixcbiAgICAgIGhlYWRlcnM6IHJlcS5jb25maWcuaGVhZGVycyxcbiAgICAgIGlwOiByZXEuY29uZmlnLmlwLFxuICAgICAgam9iTmFtZSxcbiAgICAgIG1lc3NhZ2U6IGpvYkhhbmRsZXIuc2V0TWVzc2FnZS5iaW5kKGpvYkhhbmRsZXIpXG4gICAgfTtcblxuICAgIHJldHVybiBqb2JIYW5kbGVyLnNldFJ1bm5pbmcoam9iTmFtZSwgcGFyYW1zKS50aGVuKChqb2JTdGF0dXMpID0+IHtcbiAgICAgIHJlcXVlc3Quam9iSWQgPSBqb2JTdGF0dXMub2JqZWN0SWRcbiAgICAgIC8vIHJ1biB0aGUgZnVuY3Rpb24gYXN5bmNcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gam9iRnVuY3Rpb24ocmVxdWVzdCk7XG4gICAgICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIGpvYkhhbmRsZXIuc2V0U3VjY2VlZGVkKHJlc3VsdCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgIGpvYkhhbmRsZXIuc2V0RmFpbGVkKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnWC1QYXJzZS1Kb2ItU3RhdHVzLUlkJzogam9iU3RhdHVzLm9iamVjdElkXG4gICAgICAgIH0sXG4gICAgICAgIHJlc3BvbnNlOiB7fVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZVJlc3BvbnNlT2JqZWN0KHJlc29sdmUsIHJlamVjdCwgbWVzc2FnZSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHJlc3VsdDogUGFyc2UuX2VuY29kZShyZXN1bHQpXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBlcnJvcjogZnVuY3Rpb24obWVzc2FnZSkge1xuICAgICAgICAvLyBwYXJzZSBlcnJvciwgcHJvY2VzcyBhd2F5XG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgUGFyc2UuRXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29kZSA9IFBhcnNlLkVycm9yLlNDUklQVF9GQUlMRUQ7XG4gICAgICAgIC8vIElmIGl0J3MgYW4gZXJyb3IsIG1hcmsgaXQgYXMgYSBzY3JpcHQgZmFpbGVkXG4gICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBQYXJzZS5FcnJvcihjb2RlLCBtZXNzYWdlKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgcmVqZWN0KG5ldyBQYXJzZS5FcnJvcihjb2RlLCBtZXNzYWdlKSk7XG4gICAgICB9LFxuICAgICAgbWVzc2FnZTogbWVzc2FnZVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBoYW5kbGVDbG91ZEZ1bmN0aW9uKHJlcSkge1xuICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lO1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uSWQgPSByZXEuY29uZmlnLmFwcGxpY2F0aW9uSWQ7XG4gICAgY29uc3QgdGhlRnVuY3Rpb24gPSB0cmlnZ2Vycy5nZXRGdW5jdGlvbihmdW5jdGlvbk5hbWUsIGFwcGxpY2F0aW9uSWQpO1xuICAgIGNvbnN0IHRoZVZhbGlkYXRvciA9IHRyaWdnZXJzLmdldFZhbGlkYXRvcihyZXEucGFyYW1zLmZ1bmN0aW9uTmFtZSwgYXBwbGljYXRpb25JZCk7XG4gICAgaWYgKCF0aGVGdW5jdGlvbikge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlNDUklQVF9GQUlMRUQsIGBJbnZhbGlkIGZ1bmN0aW9uOiBcIiR7ZnVuY3Rpb25OYW1lfVwiYCk7XG4gICAgfVxuICAgIGxldCBwYXJhbXMgPSBPYmplY3QuYXNzaWduKHt9LCByZXEuYm9keSwgcmVxLnF1ZXJ5KTtcbiAgICBwYXJhbXMgPSBwYXJzZVBhcmFtcyhwYXJhbXMpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBwYXJhbXM6IHBhcmFtcyxcbiAgICAgIG1hc3RlcjogcmVxLmF1dGggJiYgcmVxLmF1dGguaXNNYXN0ZXIsXG4gICAgICB1c2VyOiByZXEuYXV0aCAmJiByZXEuYXV0aC51c2VyLFxuICAgICAgaW5zdGFsbGF0aW9uSWQ6IHJlcS5pbmZvLmluc3RhbGxhdGlvbklkLFxuICAgICAgbG9nOiByZXEuY29uZmlnLmxvZ2dlckNvbnRyb2xsZXIsXG4gICAgICBoZWFkZXJzOiByZXEuY29uZmlnLmhlYWRlcnMsXG4gICAgICBpcDogcmVxLmNvbmZpZy5pcCxcbiAgICAgIGZ1bmN0aW9uTmFtZVxuICAgIH07XG5cbiAgICBpZiAodGhlVmFsaWRhdG9yICYmIHR5cGVvZiB0aGVWYWxpZGF0b3IgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgdmFyIHJlc3VsdCA9IHRoZVZhbGlkYXRvcihyZXF1ZXN0KTtcbiAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5WQUxJREFUSU9OX0VSUk9SLCAnVmFsaWRhdGlvbiBmYWlsZWQuJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGNvbnN0IHVzZXJTdHJpbmcgPSAocmVxLmF1dGggJiYgcmVxLmF1dGgudXNlcikgPyByZXEuYXV0aC51c2VyLmlkIDogdW5kZWZpbmVkO1xuICAgICAgY29uc3QgY2xlYW5JbnB1dCA9IGxvZ2dlci50cnVuY2F0ZUxvZ01lc3NhZ2UoSlNPTi5zdHJpbmdpZnkocGFyYW1zKSk7XG4gICAgICBjb25zdCB7IHN1Y2Nlc3MsIGVycm9yLCBtZXNzYWdlIH0gPSBGdW5jdGlvbnNSb3V0ZXIuY3JlYXRlUmVzcG9uc2VPYmplY3QoKHJlc3VsdCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGNsZWFuUmVzdWx0ID0gbG9nZ2VyLnRydW5jYXRlTG9nTWVzc2FnZShKU09OLnN0cmluZ2lmeShyZXN1bHQucmVzcG9uc2UucmVzdWx0KSk7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgICAgICBgUmFuIGNsb3VkIGZ1bmN0aW9uICR7ZnVuY3Rpb25OYW1lfSBmb3IgdXNlciAke3VzZXJTdHJpbmd9IHdpdGg6XFxuICBJbnB1dDogJHtjbGVhbklucHV0IH1cXG4gIFJlc3VsdDogJHtjbGVhblJlc3VsdCB9YCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgIHVzZXI6IHVzZXJTdHJpbmcsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgIGBGYWlsZWQgcnVubmluZyBjbG91ZCBmdW5jdGlvbiAke2Z1bmN0aW9uTmFtZX0gZm9yIHVzZXIgJHt1c2VyU3RyaW5nfSB3aXRoOlxcbiAgSW5wdXQ6ICR7Y2xlYW5JbnB1dH1cXG4gIEVycm9yOiBgICsgSlNPTi5zdHJpbmdpZnkoZXJyb3IpLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBmdW5jdGlvbk5hbWUsXG4gICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgIHVzZXI6IHVzZXJTdHJpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhlRnVuY3Rpb24ocmVxdWVzdCwgeyBtZXNzYWdlIH0pO1xuICAgICAgfSkudGhlbihzdWNjZXNzLCBlcnJvcik7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==