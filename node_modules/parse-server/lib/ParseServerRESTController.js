'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
const Config = require('./Config');
const Auth = require('./Auth');
const RESTController = require('parse/lib/node/RESTController');
const URL = require('url');
const Parse = require('parse/node');

function getSessionToken(options) {
  if (options && typeof options.sessionToken === 'string') {
    return Promise.resolve(options.sessionToken);
  }
  return Promise.resolve(null);
}

function getAuth(options = {}, config) {
  const installationId = options.installationId || 'cloud';
  if (options.useMasterKey) {
    return Promise.resolve(new Auth.Auth({ config, isMaster: true, installationId }));
  }
  return getSessionToken(options).then(sessionToken => {
    if (sessionToken) {
      options.sessionToken = sessionToken;
      return Auth.getAuthForSessionToken({
        config,
        sessionToken: sessionToken,
        installationId
      });
    } else {
      return Promise.resolve(new Auth.Auth({ config, installationId }));
    }
  });
}

function ParseServerRESTController(applicationId, router) {
  function handleRequest(method, path, data = {}, options = {}) {
    // Store the arguments, for later use if internal fails
    const args = arguments;

    const config = Config.get(applicationId);
    const serverURL = URL.parse(config.serverURL);
    if (path.indexOf(serverURL.path) === 0) {
      path = path.slice(serverURL.path.length, path.length);
    }

    if (path[0] !== "/") {
      path = "/" + path;
    }

    if (path === '/batch') {
      const promises = data.requests.map(request => {
        return handleRequest(request.method, request.path, request.body, options).then(response => {
          return Promise.resolve({ success: response });
        }, error => {
          return Promise.resolve({ error: { code: error.code, error: error.message } });
        });
      });
      return Promise.all(promises);
    }

    let query;
    if (method === 'GET') {
      query = data;
    }

    return new Promise((resolve, reject) => {
      getAuth(options, config).then(auth => {
        const request = {
          body: data,
          config,
          auth,
          info: {
            applicationId: applicationId,
            sessionToken: options.sessionToken
          },
          query
        };
        return Promise.resolve().then(() => {
          return router.tryRouteRequest(method, path, request);
        }).then(response => {
          resolve(response.response, response.status, response);
        }, err => {
          if (err instanceof Parse.Error && err.code == Parse.Error.INVALID_JSON && err.message == `cannot route ${method} ${path}`) {
            RESTController.request.apply(null, args).then(resolve, reject);
          } else {
            reject(err);
          }
        });
      }, reject);
    });
  }

  return {
    request: handleRequest,
    ajax: RESTController.ajax
  };
}

exports.default = ParseServerRESTController;
exports.ParseServerRESTController = ParseServerRESTController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9QYXJzZVNlcnZlclJFU1RDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbmZpZyIsInJlcXVpcmUiLCJBdXRoIiwiUkVTVENvbnRyb2xsZXIiLCJVUkwiLCJQYXJzZSIsImdldFNlc3Npb25Ub2tlbiIsIm9wdGlvbnMiLCJzZXNzaW9uVG9rZW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsImdldEF1dGgiLCJjb25maWciLCJpbnN0YWxsYXRpb25JZCIsInVzZU1hc3RlcktleSIsImlzTWFzdGVyIiwidGhlbiIsImdldEF1dGhGb3JTZXNzaW9uVG9rZW4iLCJQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyIiwiYXBwbGljYXRpb25JZCIsInJvdXRlciIsImhhbmRsZVJlcXVlc3QiLCJtZXRob2QiLCJwYXRoIiwiZGF0YSIsImFyZ3MiLCJhcmd1bWVudHMiLCJnZXQiLCJzZXJ2ZXJVUkwiLCJwYXJzZSIsImluZGV4T2YiLCJzbGljZSIsImxlbmd0aCIsInByb21pc2VzIiwicmVxdWVzdHMiLCJtYXAiLCJyZXF1ZXN0IiwiYm9keSIsInJlc3BvbnNlIiwic3VjY2VzcyIsImVycm9yIiwiY29kZSIsIm1lc3NhZ2UiLCJhbGwiLCJxdWVyeSIsInJlamVjdCIsImF1dGgiLCJpbmZvIiwidHJ5Um91dGVSZXF1ZXN0Iiwic3RhdHVzIiwiZXJyIiwiRXJyb3IiLCJJTlZBTElEX0pTT04iLCJhcHBseSIsImFqYXgiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsTUFBTUEsU0FBU0MsUUFBUSxVQUFSLENBQWY7QUFDQSxNQUFNQyxPQUFPRCxRQUFRLFFBQVIsQ0FBYjtBQUNBLE1BQU1FLGlCQUFpQkYsUUFBUSwrQkFBUixDQUF2QjtBQUNBLE1BQU1HLE1BQU1ILFFBQVEsS0FBUixDQUFaO0FBQ0EsTUFBTUksUUFBUUosUUFBUSxZQUFSLENBQWQ7O0FBRUEsU0FBU0ssZUFBVCxDQUF5QkMsT0FBekIsRUFBa0M7QUFDaEMsTUFBSUEsV0FBVyxPQUFPQSxRQUFRQyxZQUFm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RCxJQUFVO0FBQ3RDLGNBQU1WLFVBQVU7QUFDZEMsZ0JBQU1iLElBRFE7QUFFZFosZ0JBRmM7QUFHZGtDLGNBSGM7QUFJZEMsZ0JBQU07QUFDSjVCLDJCQUFlQSxhQURYO0FBRUpYLDBCQUFjRCxRQUFRQztBQUZsQixXQUpRO0FBUWRvQztBQVJjLFNBQWhCO0FBVUEsZUFBT25DLFFBQVFDLE9BQVIsR0FBa0JNLElBQWxCLENBQXVCLE1BQU07QUFDbEMsaUJBQU9JLE9BQU80QixlQUFQLENBQXVCMUIsTUFBdkIsRUFBK0JDLElBQS9CLEVBQXFDYSxPQUFyQyxDQUFQO0FBQ0QsU0FGTSxFQUVKcEIsSUFGSSxDQUVFc0IsUUFBRCxJQUFjO0FBQ3BCNUIsa0JBQVE0QixTQUFTQSxRQUFqQixFQUEyQkEsU0FBU1csTUFBcEMsRUFBNENYLFFBQTVDO0FBQ0QsU0FKTSxFQUlIWSxHQUFELElBQVM7QUFDVixjQUFJQSxlQUFlN0MsTUFBTThDLEtBQXJCLElBQ0FELElBQUlULElBQUosSUFBWXBDLE1BQU04QyxLQUFOLENBQVlDLFlBRHhCLElBRUFGLElBQUlSLE9BQUosSUFBZ0IsZ0JBQWVwQixNQUFPLElBQUdDLElBQUssRUFGbEQsRUFFcUQ7QUFDbkRwQiwyQkFBZWlDLE9BQWYsQ0FBdUJpQixLQUF2QixDQUE2QixJQUE3QixFQUFtQzVCLElBQW5DLEVBQXlDVCxJQUF6QyxDQUE4Q04sT0FBOUMsRUFBdURtQyxNQUF2RDtBQUNELFdBSkQsTUFJTztBQUNMQSxtQkFBT0ssR0FBUDtBQUNEO0FBQ0YsU0FaTSxDQUFQO0FBYUQsT0F4QkQsRUF3QkdMLE1BeEJIO0FBeUJELEtBMUJNLENBQVA7QUEyQkQ7O0FBRUQsU0FBUTtBQUNOVCxhQUFTZixhQURIO0FBRU5pQyxVQUFNbkQsZUFBZW1EO0FBRmYsR0FBUjtBQUlEOztrQkFFY3BDLHlCO1FBQ05BLHlCLEdBQUFBLHlCIiwiZmlsZSI6IlBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBDb25maWcgPSByZXF1aXJlKCcuL0NvbmZpZycpO1xuY29uc3QgQXV0aCA9IHJlcXVpcmUoJy4vQXV0aCcpO1xuY29uc3QgUkVTVENvbnRyb2xsZXIgPSByZXF1aXJlKCdwYXJzZS9saWIvbm9kZS9SRVNUQ29udHJvbGxlcicpO1xuY29uc3QgVVJMID0gcmVxdWlyZSgndXJsJyk7XG5jb25zdCBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKTtcblxuZnVuY3Rpb24gZ2V0U2Vzc2lvblRva2VuKG9wdGlvbnMpIHtcbiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMuc2Vzc2lvblRva2VuID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob3B0aW9ucy5zZXNzaW9uVG9rZW4pO1xuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG59XG5cbmZ1bmN0aW9uIGdldEF1dGgob3B0aW9ucyA9IHt9LCBjb25maWcpIHtcbiAgY29uc3QgaW5zdGFsbGF0aW9uSWQgPSBvcHRpb25zLmluc3RhbGxhdGlvbklkIHx8ICdjbG91ZCc7XG4gIGlmIChvcHRpb25zLnVzZU1hc3RlcktleSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IEF1dGguQXV0aCh7Y29uZmlnLCBpc01hc3RlcjogdHJ1ZSwgaW5zdGFsbGF0aW9uSWQgfSkpO1xuICB9XG4gIHJldHVybiBnZXRTZXNzaW9uVG9rZW4ob3B0aW9ucykudGhlbigoc2Vzc2lvblRva2VuKSA9PiB7XG4gICAgaWYgKHNlc3Npb25Ub2tlbikge1xuICAgICAgb3B0aW9ucy5zZXNzaW9uVG9rZW4gPSBzZXNzaW9uVG9rZW47XG4gICAgICByZXR1cm4gQXV0aC5nZXRBdXRoRm9yU2Vzc2lvblRva2VuKHtcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBzZXNzaW9uVG9rZW46IHNlc3Npb25Ub2tlbixcbiAgICAgICAgaW5zdGFsbGF0aW9uSWRcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBBdXRoLkF1dGgoeyBjb25maWcsIGluc3RhbGxhdGlvbklkIH0pKTtcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXIoYXBwbGljYXRpb25JZCwgcm91dGVyKSB7XG4gIGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QobWV0aG9kLCBwYXRoLCBkYXRhID0ge30sIG9wdGlvbnMgPSB7fSkge1xuICAgIC8vIFN0b3JlIHRoZSBhcmd1bWVudHMsIGZvciBsYXRlciB1c2UgaWYgaW50ZXJuYWwgZmFpbHNcbiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzO1xuXG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChhcHBsaWNhdGlvbklkKTtcbiAgICBjb25zdCBzZXJ2ZXJVUkwgPSBVUkwucGFyc2UoY29uZmlnLnNlcnZlclVSTCk7XG4gICAgaWYgKHBhdGguaW5kZXhPZihzZXJ2ZXJVUkwucGF0aCkgPT09IDApIHtcbiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHNlcnZlclVSTC5wYXRoLmxlbmd0aCwgcGF0aC5sZW5ndGgpO1xuICAgIH1cblxuICAgIGlmIChwYXRoWzBdICE9PSBcIi9cIikge1xuICAgICAgcGF0aCA9IFwiL1wiICsgcGF0aDtcbiAgICB9XG5cbiAgICBpZiAocGF0aCA9PT0gJy9iYXRjaCcpIHtcbiAgICAgIGNvbnN0IHByb21pc2VzID0gZGF0YS5yZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+IHtcbiAgICAgICAgcmV0dXJuIGhhbmRsZVJlcXVlc3QocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCwgcmVxdWVzdC5ib2R5LCBvcHRpb25zKS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3N1Y2Nlc3M6IHJlc3BvbnNlfSk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe2Vycm9yOiB7Y29kZTogZXJyb3IuY29kZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2V9fSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIGxldCBxdWVyeTtcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcXVlcnkgPSBkYXRhO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBnZXRBdXRoKG9wdGlvbnMsIGNvbmZpZykudGhlbigoYXV0aCkgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgIGJvZHk6IGRhdGEsXG4gICAgICAgICAgY29uZmlnLFxuICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgaW5mbzoge1xuICAgICAgICAgICAgYXBwbGljYXRpb25JZDogYXBwbGljYXRpb25JZCxcbiAgICAgICAgICAgIHNlc3Npb25Ub2tlbjogb3B0aW9ucy5zZXNzaW9uVG9rZW5cbiAgICAgICAgICB9LFxuICAgICAgICAgIHF1ZXJ5XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gcm91dGVyLnRyeVJvdXRlUmVxdWVzdChtZXRob2QsIHBhdGgsIHJlcXVlc3QpO1xuICAgICAgICB9KS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UucmVzcG9uc2UsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UpO1xuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFBhcnNlLkVycm9yICYmXG4gICAgICAgICAgICAgIGVyci5jb2RlID09IFBhcnNlLkVycm9yLklOVkFMSURfSlNPTiAmJlxuICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9PSBgY2Fubm90IHJvdXRlICR7bWV0aG9kfSAke3BhdGh9YCkge1xuICAgICAgICAgICAgUkVTVENvbnRyb2xsZXIucmVxdWVzdC5hcHBseShudWxsLCBhcmdzKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LCByZWplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuICB7XG4gICAgcmVxdWVzdDogaGFuZGxlUmVxdWVzdCxcbiAgICBhamF4OiBSRVNUQ29udHJvbGxlci5hamF4XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXI7XG5leHBvcnQgeyBQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyIH07XG4iXX0=