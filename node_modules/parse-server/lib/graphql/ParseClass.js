'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseClass = exports.ParseObject = exports.ParseObjectInterface = undefined;
exports.loadClass = loadClass;

var _graphql = require('graphql');

var _types = require('./types');

function graphQLField(fieldName, field) {
  const gQLType = (0, _types.type)(fieldName, field);
  if (!gQLType) {
    /* eslint-disable */
    console.log('no type: ', fieldName, field);
    return;
  }
  const fieldType = gQLType === _types.GraphQLPointer ? `Pointer<${field.targetClass}>` : `${field.type}`;
  return {
    name: fieldName,
    type: gQLType,
    description: `Accessor for ${fieldName} (${fieldType})`
  };
}

function graphQLInputField(fieldName, field) {
  const gQLType = (0, _types.inputType)(fieldName, field);
  if (!gQLType) {
    return;
  }
  const fieldType = gQLType === _types.GraphQLPointer ? `Pointer<${field.targetClass}>` : `${field.type}`;
  return {
    name: fieldName,
    type: gQLType,
    description: `Setter for ${fieldName} (${fieldType})`
  };
}

function graphQLQueryField(fieldName, field) {
  const gQLType = (0, _types.queryType)(fieldName, field);
  if (!gQLType) {
    return;
  }
  return {
    name: fieldName,
    type: gQLType,
    description: `Query for ${fieldName} (${field.type})`
  };
}

const ParseClassCache = {};

function loadClass(className, schema) {
  if (!ParseClassCache[className]) {
    const c = new ParseClass(className, schema);
    const objectType = c.graphQLObjectType();
    const inputType = c.graphQLInputObjectType();
    const updateType = c.graphQLUpdateInputObjectType();
    const queryType = c.graphQLQueryInputObjectType();
    ParseClassCache[className] = { objectType, inputType, updateType, queryType, class: c };
  }
  return ParseClassCache[className];
}

const reservedFieldNames = ['objectId', 'createdAt', 'updatedAt'];

const ParseObjectInterface = exports.ParseObjectInterface = new _graphql.GraphQLInterfaceType({
  name: 'ObjectType',
  fields: {
    objectId: {
      type: (0, _types.type)('objectId')
    },
    createdAt: {
      type: (0, _types.type)(null, { type: 'Date' })
    },
    updatedAt: {
      type: (0, _types.type)(null, { type: 'Date' })
    },
    ACL: {
      type: (0, _types.type)(null, { type: 'ACL' })
    }
  }
});

const ParseObject = exports.ParseObject = new _graphql.GraphQLObjectType({
  name: 'Object',
  interfaces: [ParseObjectInterface],
  fields: {
    objectId: {
      type: (0, _types.type)('objectId')
    },
    createdAt: {
      type: (0, _types.type)(null, { type: 'Date' })
    },
    updatedAt: {
      type: (0, _types.type)(null, { type: 'Date' })
    },
    ACL: {
      type: (0, _types.type)(null, { type: 'ACL' })
    },
    data: {
      type: _types.GraphQLJSONObject
    }
  },
  isTypeOf: (args, context, info) => {
    // Use that type when impossible to map to a Schema type
    return typeof info.schema._typeMap[args.className] === 'undefined';
  },
  resolve: () => {
    /* eslint-disable */
    console.log('RESOLVE CALLED!');
    /* eslint-enable */
  }
});

class ParseClass {

  constructor(className, schema) {
    this.className = className;
    this.schema = schema;
    this.class = this.schema[className];
  }

  graphQLConfig() {
    const className = this.className;
    return {
      name: className,
      description: `Parse Class ${className}`,
      interfaces: [ParseObjectInterface],
      fields: () => {
        return this.buildFields(graphQLField, false, true);
      },
      resolve: () => {
        return;
      },
      isTypeOf: function (a) {
        return a.className == className;
      }
    };
  }

  buildFields(mapper, filterReserved = false, isQuery = false) {
    const fields = this.class.fields;
    return Object.keys(fields).reduce((memo, fieldName) => {
      if (filterReserved && reservedFieldNames.indexOf(fieldName) >= 0) {
        return memo;
      }
      const field = fields[fieldName];
      let gQLField = mapper(fieldName, field);
      if (field.type == 'Pointer' && isQuery) {
        gQLField = {
          type: loadClass(field.targetClass, this.schema).objectType
        };
      }
      if (!gQLField) {
        return memo;
      }
      memo[fieldName] = gQLField;
      return memo;
    }, {});
  }

  graphQLInputConfig() {
    const className = this.className;
    return {
      name: className + 'Input',
      description: `Parse Class ${className} Input`,
      fields: () => {
        return this.buildFields(graphQLInputField, true);
      },
      resolve: this.get.bind(this),
      isTypeOf: function (input) {
        return input.className == className;
      }
    };
  }

  graphQLQueryConfig() {
    const className = this.className;
    return {
      name: className + 'Query',
      description: `Parse Class ${className} Query`,
      fields: () => {
        return this.buildFields(graphQLQueryField, true);
      },
      resolve: this.get.bind(this),
      isTypeOf: function (input) {
        return input.className == className;
      }
    };
  }

  graphQLUpdateInputConfig() {
    const className = this.className;
    return {
      name: className + 'Update',
      description: `Parse Class ${className} Update`,
      fields: () => {
        return this.buildFields(graphQLInputField, true);
      },
      resolve: this.get.bind(this),
      isTypeOf: function (input) {
        return input.className == className;
      }
    };
  }

  graphQLUpdateInputObjectType() {
    return new _graphql.GraphQLInputObjectType(this.graphQLUpdateInputConfig());
  }

  graphQLInputObjectType() {
    return new _graphql.GraphQLInputObjectType(this.graphQLInputConfig());
  }

  graphQLQueryInputObjectType() {
    return new _graphql.GraphQLInputObjectType(this.graphQLQueryConfig());
  }

  graphQLObjectType() {
    return new _graphql.GraphQLObjectType(this.graphQLConfig());
  }

  get(a, b, c) {
    /*eslint-disable*/
    console.log('ParseClass resolve...');
    console.log(a, b, c);
    /* eslint-enable */
    return null;
  }
}
exports.ParseClass = ParseClass;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncmFwaHFsL1BhcnNlQ2xhc3MuanMiXSwibmFtZXMiOlsibG9hZENsYXNzIiwiZ3JhcGhRTEZpZWxkIiwiZmllbGROYW1lIiwiZmllbGQiLCJnUUxUeXBlIiwiY29uc29sZSIsImxvZyIsImZpZWxkVHlwZSIsIkdyYXBoUUxQb2ludGVyIiwidGFyZ2V0Q2xhc3MiLCJ0eXBlIiwibmFtZSIsImRlc2NyaXB0aW9uIiwiZ3JhcGhRTElucHV0RmllbGQiLCJncmFwaFFMUXVlcnlGaWVsZCIsIlBhcnNlQ2xhc3NDYWNoZSIsImNsYXNzTmFtZSIsInNjaGVtYSIsImMiLCJQYXJzZUNsYXNzIiwib2JqZWN0VHlwZSIsImdyYXBoUUxPYmplY3RUeXBlIiwiaW5wdXRUeXBlIiwiZ3JhcGhRTElucHV0T2JqZWN0VHlwZSIsInVwZGF0ZVR5cGUiLCJncmFwaFFMVXBkYXRlSW5wdXRPYmplY3RUeXBlIiwicXVlcnlUeXBlIiwiZ3JhcGhRTFF1ZXJ5SW5wdXRPYmplY3RUeXBlIiwiY2xhc3MiLCJyZXNlcnZlZEZpZWxkTmFtZXMiLCJQYXJzZU9iamVjdEludGVyZmFjZSIsIkdyYXBoUUxJbnRlcmZhY2VUeXBlIiwiZmllbGRzIiwib2JqZWN0SWQiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJBQ0wiLCJQYXJzZU9iamVjdCIsIkdyYXBoUUxPYmplY3RUeXBlIiwiaW50ZXJmYWNlcyIsImRhdGEiLCJHcmFwaFFMSlNPTk9iamVjdCIsImlzVHlwZU9mIiwiYXJncyIsImNvbnRleHQiLCJpbmZvIiwiX3R5cGVNYXAiLCJyZXNvbHZlIiwiY29uc3RydWN0b3IiLCJncmFwaFFMQ29uZmlnIiwiYnVpbGRGaWVsZHMiLCJhIiwibWFwcGVyIiwiZmlsdGVyUmVzZXJ2ZWQiLCJpc1F1ZXJ5IiwiT2JqZWN0Iiwia2V5cyIsInJlZHVjZSIsIm1lbW8iLCJpbmRleE9mIiwiZ1FMRmllbGQiLCJncmFwaFFMSW5wdXRDb25maWciLCJnZXQiLCJiaW5kIiwiaW5wdXQiLCJncmFwaFFMUXVlcnlDb25maWciLCJncmFwaFFMVXBkYXRlSW5wdXRDb25maWciLCJHcmFwaFFMSW5wdXRPYmplY3RUeXBlIiwiYiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O1FBNkRnQkEsUyxHQUFBQSxTOztBQTdEaEI7O0FBVUE7O0FBU0EsU0FBU0MsWUFBVCxDQUFzQkMsU0FBdEIsRUFBaUNDLEtBQWpDLEVBQXdDO0FBQ3RDLFFBQU1DLFVBQVUsaUJBQUtGLFNBQUwsRUFBZ0JDLEtBQWhCLENBQWhCO0FBQ0EsTUFBSSxDQUFDQyxPQUFMLEVBQWM7QUFDWjtBQUNBQyxZQUFRQyxHQUFSLENBQVksV0FBWixFQUF5QkosU0FBekIsRUFBb0NDLEtBQXBDO0FBQ0E7QUFDRDtBQUNELFFBQU1JLFlBQWFILFlBQVlJLHFCQUFaLEdBQThCLFdBQVVMLE1BQU1NLFdBQVksR0FBMUQsR0FBaUUsR0FBRU4sTUFBTU8sSUFBSyxFQUFqRztBQUNBLFNBQU87QUFDTEMsVUFBTVQsU0FERDtBQUVMUSxVQUFNTixPQUZEO0FBR0xRLGlCQUFjLGdCQUFlVixTQUFVLEtBQUlLLFNBQVU7QUFIaEQsR0FBUDtBQUtEOztBQUVELFNBQVNNLGlCQUFULENBQTJCWCxTQUEzQixFQUFzQ0MsS0FBdEMsRUFBNkM7QUFDM0MsUUFBTUMsVUFBVSxzQkFBVUYsU0FBVixFQUFxQkMsS0FBckIsQ0FBaEI7QUFDQSxNQUFJLENBQUNDLE9BQUwsRUFBYztBQUNaO0FBQ0Q7QUFDRCxRQUFNRyxZQUFhSCxZQUFZSSxxQkFBWixHQUE4QixXQUFVTCxNQUFNTSxXQUFZLEdBQTFELEdBQWlFLEdBQUVOLE1BQU1PLElBQUssRUFBakc7QUFDQSxTQUFPO0FBQ0xDLFVBQU1ULFNBREQ7QUFFTFEsVUFBTU4sT0FGRDtBQUdMUSxpQkFBYyxjQUFhVixTQUFVLEtBQUlLLFNBQVU7QUFIOUMsR0FBUDtBQUtEOztBQUVELFNBQVNPLGlCQUFULENBQTJCWixTQUEzQixFQUFzQ0MsS0FBdEMsRUFBNkM7QUFDM0MsUUFBTUMsVUFBVSxzQkFBVUYsU0FBVixFQUFxQkMs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QUNELE9BTEk7QUFNTGtDLGVBQVMsS0FBS2UsR0FBTCxDQUFTQyxJQUFULENBQWMsSUFBZCxDQU5KO0FBT0xyQixnQkFBVSxVQUFTc0IsS0FBVCxFQUFnQjtBQUN4QixlQUFPQSxNQUFNaEQsU0FBTixJQUFtQkEsU0FBMUI7QUFDRDtBQVRJLEtBQVA7QUFXRDs7QUFFRFMsaUNBQStCO0FBQzdCLFdBQU8sSUFBSTBDLCtCQUFKLENBQTJCLEtBQUtELHdCQUFMLEVBQTNCLENBQVA7QUFDRDs7QUFFRDNDLDJCQUF5QjtBQUN2QixXQUFPLElBQUk0QywrQkFBSixDQUEyQixLQUFLTixrQkFBTCxFQUEzQixDQUFQO0FBQ0Q7O0FBRURsQyxnQ0FBOEI7QUFDNUIsV0FBTyxJQUFJd0MsK0JBQUosQ0FBMkIsS0FBS0Ysa0JBQUwsRUFBM0IsQ0FBUDtBQUNEOztBQUVENUMsc0JBQW9CO0FBQ2xCLFdBQU8sSUFBSWlCLDBCQUFKLENBQXNCLEtBQUtXLGFBQUwsRUFBdEIsQ0FBUDtBQUNEOztBQUVEYSxNQUFJWCxDQUFKLEVBQU1pQixDQUFOLEVBQVFsRCxDQUFSLEVBQVc7QUFDVDtBQUNBYixZQUFRQyxHQUFSLENBQVksdUJBQVo7QUFDQUQsWUFBUUMsR0FBUixDQUFZNkMsQ0FBWixFQUFjaUIsQ0FBZCxFQUFnQmxELENBQWhCO0FBQ0E7QUFDQSxXQUFPLElBQVA7QUFDRDtBQXJIcUI7UUFBWEMsVSxHQUFBQSxVIiwiZmlsZSI6IlBhcnNlQ2xhc3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBHcmFwaFFMSW50ZXJmYWNlVHlwZSxcbiAgR3JhcGhRTE9iamVjdFR5cGUsXG4gIEdyYXBoUUxJbnB1dE9iamVjdFR5cGUsXG4gIC8vIEdyYXBoUUxTdHJpbmcsXG4gIC8vIEdyYXBoUUxOb25OdWxsLFxuICAvLyBHcmFwaFFMQm9vbGVhbixcbiAgLy8gR3JhcGhRTElELFxufSBmcm9tICdncmFwaHFsJ1xuXG5pbXBvcnQge1xuICBxdWVyeVR5cGUsXG4gIGlucHV0VHlwZSxcbiAgdHlwZSxcbiAgLy8gR3JhcGhRTEdlb1BvaW50LFxuICBHcmFwaFFMUG9pbnRlcixcbiAgR3JhcGhRTEpTT05PYmplY3Rcbn0gZnJvbSAnLi90eXBlcydcblxuZnVuY3Rpb24gZ3JhcGhRTEZpZWxkKGZpZWxkTmFtZSwgZmllbGQpIHtcbiAgY29uc3QgZ1FMVHlwZSA9IHR5cGUoZmllbGROYW1lLCBmaWVsZCk7XG4gIGlmICghZ1FMVHlwZSkge1xuICAgIC8qIGVzbGludC1kaXNhYmxlICovXG4gICAgY29uc29sZS5sb2coJ25vIHR5cGU6ICcsIGZpZWxkTmFtZSwgZmllbGQpO1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBmaWVsZFR5cGUgPSAoZ1FMVHlwZSA9PT0gR3JhcGhRTFBvaW50ZXIgPyBgUG9pbnRlcjwke2ZpZWxkLnRhcmdldENsYXNzfT5gIDogIGAke2ZpZWxkLnR5cGV9YCk7XG4gIHJldHVybiB7XG4gICAgbmFtZTogZmllbGROYW1lLFxuICAgIHR5cGU6IGdRTFR5cGUsXG4gICAgZGVzY3JpcHRpb246IGBBY2Nlc3NvciBmb3IgJHtmaWVsZE5hbWV9ICgke2ZpZWxkVHlwZX0pYCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ3JhcGhRTElucHV0RmllbGQoZmllbGROYW1lLCBmaWVsZCkge1xuICBjb25zdCBnUUxUeXBlID0gaW5wdXRUeXBlKGZpZWxkTmFtZSwgZmllbGQpO1xuICBpZiAoIWdRTFR5cGUpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZmllbGRUeXBlID0gKGdRTFR5cGUgPT09IEdyYXBoUUxQb2ludGVyID8gYFBvaW50ZXI8JHtmaWVsZC50YXJnZXRDbGFzc30+YCA6ICBgJHtmaWVsZC50eXBlfWApO1xuICByZXR1cm4ge1xuICAgIG5hbWU6IGZpZWxkTmFtZSxcbiAgICB0eXBlOiBnUUxUeXBlLFxuICAgIGRlc2NyaXB0aW9uOiBgU2V0dGVyIGZvciAke2ZpZWxkTmFtZX0gKCR7ZmllbGRUeXBlfSlgLFxuICB9O1xufVxuXG5mdW5jdGlvbiBncmFwaFFMUXVlcnlGaWVsZChmaWVsZE5hbWUsIGZpZWxkKSB7XG4gIGNvbnN0IGdRTFR5cGUgPSBxdWVyeVR5cGUoZmllbGROYW1lLCBmaWVsZCk7XG4gIGlmICghZ1FMVHlwZSkge1xuICAgIHJldHVybjtcbiAgfVxuICByZXR1cm4ge1xuICAgIG5hbWU6IGZpZWxkTmFtZSxcbiAgICB0eXBlOiBnUUxUeXBlLFxuICAgIGRlc2NyaXB0aW9uOiBgUXVlcnkgZm9yICR7ZmllbGROYW1lfSAoJHtmaWVsZC50eXBlfSlgLFxuICB9O1xufVxuXG5jb25zdCBQYXJzZUNsYXNzQ2FjaGUgPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDbGFzcyhjbGFzc05hbWUsIHNjaGVtYSkge1xuICBpZiAoIVBhcnNlQ2xhc3NDYWNoZVtjbGFzc05hbWVdKSB7XG4gICAgY29uc3QgYyA9IG5ldyBQYXJzZUNsYXNzKGNsYXNzTmFtZSwgc2NoZW1hKTtcbiAgICBjb25zdCBvYmplY3RUeXBlID0gYy5ncmFwaFFMT2JqZWN0VHlwZSgpO1xuICAgIGNvbnN0IGlucHV0VHlwZSA9IGMuZ3JhcGhRTElucHV0T2JqZWN0VHlwZSgpO1xuICAgIGNvbnN0IHVwZGF0ZVR5cGUgPSBjLmdyYXBoUUxVcGRhdGVJbnB1dE9iamVjdFR5cGUoKTtcbiAgICBjb25zdCBxdWVyeVR5cGUgPSBjLmdyYXBoUUxRdWVyeUlucHV0T2JqZWN0VHlwZSgpXG4gICAgUGFyc2VDbGFzc0NhY2hlW2NsYXNzTmFtZV0gPSB7IG9iamVjdFR5cGUsIGlucHV0VHlwZSwgdXBkYXRlVHlwZSwgcXVlcnlUeXBlLCBjbGFzczogYyB9XG4gIH1cbiAgcmV0dXJuIFBhcnNlQ2xhc3NDYWNoZVtjbGFzc05hbWVdO1xufVxuXG5jb25zdCByZXNlcnZlZEZpZWxkTmFtZXMgPSBbJ29iamVjdElkJywgJ2NyZWF0ZWRBdCcsICd1cGRhdGVkQXQnXTtcblxuZXhwb3J0IGNvbnN0IFBhcnNlT2JqZWN0SW50ZXJmYWNlID0gbmV3IEdyYXBoUUxJbnRlcmZhY2VUeXBlKHtcbiAgbmFtZTogJ09iamVjdFR5cGUnLFxuICBmaWVsZHM6IHtcbiAgICBvYmplY3RJZDoge1xuICAgICAgdHlwZTogdHlwZSgnb2JqZWN0SWQnKVxuICAgIH0sXG4gICAgY3JlYXRlZEF0OiB7XG4gICAgICB0eXBlOiB0eXBlKG51bGwsIHt0eXBlOiAnRGF0ZSd9KVxuICAgIH0sXG4gICAgdXBkYXRlZEF0OiB7XG4gICAgICB0eXBlOiB0eXBlKG51bGwsIHt0eXBlOiAnRGF0ZSd9KVxuICAgIH0sXG4gICAgQUNMOiB7XG4gICAgICB0eXBlOiB0eXBlKG51bGwsIHt0eXBlOiAnQUNMJ30pXG4gICAgfVxuICB9XG59KTtcblxuZXhwb3J0IGNvbnN0IFBhcnNlT2JqZWN0ID0gbmV3IEdyYXBoUUxPYmplY3RUeXBlKHtcbiAgbmFtZTogJ09iamVjdCcsXG4gIGludGVyZmFjZXM6IFtQYXJzZU9iamVjdEludGVyZmFjZV0sXG4gIGZpZWxkczoge1xuICAgIG9iamVjdElkOiB7XG4gICAgICB0eXBlOiB0eXBlKCdvYmplY3RJZCcpXG4gICAgfSxcbiAgICBjcmVhdGVkQXQ6IHtcbiAgICAgIHR5cGU6IHR5cGUobnVsbCwge3R5cGU6ICdEYXRlJ30pXG4gICAgfSxcbiAgICB1cGRhdGVkQXQ6IHtcbiAgICAgIHR5cGU6IHR5cGUobnVsbCwge3R5cGU6ICdEYXRlJ30pXG4gICAgfSxcbiAgICBBQ0w6IHtcbiAgICAgIHR5cGU6IHR5cGUobnVsbCwge3R5cGU6ICdBQ0wnfSlcbiAgICB9LFxuICAgIGRhdGE6IHtcbiAgICAgIHR5cGU6IEdyYXBoUUxKU09OT2JqZWN0XG4gICAgfVxuICB9LFxuICBpc1R5cGVPZjogKGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IHtcbiAgICAvLyBVc2UgdGhhdCB0eXBlIHdoZW4gaW1wb3NzaWJsZSB0byBtYXAgdG8gYSBTY2hlbWEgdHlwZVxuICAgIHJldHVybiB0eXBlb2YgaW5mby5zY2hlbWEuX3R5cGVNYXBbYXJncy5jbGFzc05hbWVdID09PSAndW5kZWZpbmVkJztcbiAgfSxcbiAgcmVzb2x2ZTogKCkgPT4ge1xuICAgIC8qIGVzbGludC1kaXNhYmxlICovXG4gICAgY29uc29sZS5sb2coJ1JFU09MVkUgQ0FMTEVEIScpO1xuICAgIC8qIGVzbGludC1lbmFibGUgKi9cbiAgfVxufSk7XG5cbmV4cG9ydCBjbGFzcyBQYXJzZUNsYXNzIHtcbiAgc2NoZW1hO1xuICBjbGFzc05hbWU7XG4gIGNsYXNzO1xuXG4gIGNvbnN0cnVjdG9yKGNsYXNzTmFtZSwgc2NoZW1hKSB7XG4gICAgdGhpcy5jbGFzc05hbWUgPSBjbGFzc05hbWU7XG4gICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7XG4gICAgdGhpcy5jbGFzcyA9IHRoaXMuc2NoZW1hW2NsYXNzTmFtZV07XG4gIH1cblxuICBncmFwaFFMQ29uZmlnKCkge1xuICAgIGNvbnN0IGNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lO1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBjbGFzc05hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogYFBhcnNlIENsYXNzICR7Y2xhc3NOYW1lfWAsXG4gICAgICBpbnRlcmZhY2VzOiBbUGFyc2VPYmplY3RJbnRlcmZhY2VdLFxuICAgICAgZmllbGRzOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1aWxkRmllbGRzKGdyYXBoUUxGaWVsZCwgZmFsc2UsIHRydWUpO1xuICAgICAgfSxcbiAgICAgIHJlc29sdmU6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSxcbiAgICAgIGlzVHlwZU9mOiBmdW5jdGlvbihhKSB7XG4gICAgICAgIHJldHVybiBhLmNsYXNzTmFtZSA9PSBjbGFzc05hbWU7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGJ1aWxkRmllbGRzKG1hcHBlciwgZmlsdGVyUmVzZXJ2ZWQgPSBmYWxzZSwgaXNRdWVyeSA9IGZhbHNlKSB7XG4gICAgY29uc3QgZmllbGRzID0gdGhpcy5jbGFzcy5maWVsZHM7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGZpZWxkcykucmVkdWNlKChtZW1vLCBmaWVsZE5hbWUpID0+IHtcbiAgICAgIGlmIChmaWx0ZXJSZXNlcnZlZCAmJiByZXNlcnZlZEZpZWxkTmFtZXMuaW5kZXhPZihmaWVsZE5hbWUpID49IDApIHtcbiAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICB9XG4gICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgbGV0IGdRTEZpZWxkID0gbWFwcGVyKGZpZWxkTmFtZSwgZmllbGQpO1xuICAgICAgaWYgKGZpZWxkLnR5cGUgPT0gJ1BvaW50ZXInICYmIGlzUXVlcnkpIHtcbiAgICAgICAgZ1FMRmllbGQgPSB7XG4gICAgICAgICAgdHlwZTogbG9hZENsYXNzKGZpZWxkLnRhcmdldENsYXNzLCB0aGlzLnNjaGVtYSkub2JqZWN0VHlwZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIWdRTEZpZWxkKSB7XG4gICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgfVxuICAgICAgbWVtb1tmaWVsZE5hbWVdID0gZ1FMRmllbGQ7XG4gICAgICByZXR1cm4gbWVtbztcbiAgICB9LCB7fSk7XG4gIH1cblxuICBncmFwaFFMSW5wdXRDb25maWcoKSB7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWU7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGNsYXNzTmFtZSArICdJbnB1dCcsXG4gICAgICBkZXNjcmlwdGlvbjogYFBhcnNlIENsYXNzICR7Y2xhc3NOYW1lfSBJbnB1dGAsXG4gICAgICBmaWVsZHM6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRGaWVsZHMoZ3JhcGhRTElucHV0RmllbGQsIHRydWUpO1xuICAgICAgfSxcbiAgICAgIHJlc29sdmU6IHRoaXMuZ2V0LmJpbmQodGhpcyksXG4gICAgICBpc1R5cGVPZjogZnVuY3Rpb24oaW5wdXQpIHtcbiAgICAgICAgcmV0dXJuIGlucHV0LmNsYXNzTmFtZSA9PSBjbGFzc05hbWU7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGdyYXBoUUxRdWVyeUNvbmZpZygpIHtcbiAgICBjb25zdCBjbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZTtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogY2xhc3NOYW1lICsgJ1F1ZXJ5JyxcbiAgICAgIGRlc2NyaXB0aW9uOiBgUGFyc2UgQ2xhc3MgJHtjbGFzc05hbWV9IFF1ZXJ5YCxcbiAgICAgIGZpZWxkczogKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5idWlsZEZpZWxkcyhncmFwaFFMUXVlcnlGaWVsZCwgdHJ1ZSk7XG4gICAgICB9LFxuICAgICAgcmVzb2x2ZTogdGhpcy5nZXQuYmluZCh0aGlzKSxcbiAgICAgIGlzVHlwZU9mOiBmdW5jdGlvbihpbnB1dCkge1xuICAgICAgICByZXR1cm4gaW5wdXQuY2xhc3NOYW1lID09IGNsYXNzTmFtZTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZ3JhcGhRTFVwZGF0ZUlucHV0Q29uZmlnKCkge1xuICAgIGNvbnN0IGNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lO1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBjbGFzc05hbWUgKyAnVXBkYXRlJyxcbiAgICAgIGRlc2NyaXB0aW9uOiBgUGFyc2UgQ2xhc3MgJHtjbGFzc05hbWV9IFVwZGF0ZWAsXG4gICAgICBmaWVsZHM6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRGaWVsZHMoZ3JhcGhRTElucHV0RmllbGQsIHRydWUpO1xuICAgICAgfSxcbiAgICAgIHJlc29sdmU6IHRoaXMuZ2V0LmJpbmQodGhpcyksXG4gICAgICBpc1R5cGVPZjogZnVuY3Rpb24oaW5wdXQpIHtcbiAgICAgICAgcmV0dXJuIGlucHV0LmNsYXNzTmFtZSA9PSBjbGFzc05hbWU7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGdyYXBoUUxVcGRhdGVJbnB1dE9iamVjdFR5cGUoKSB7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFFMSW5wdXRPYmplY3RUeXBlKHRoaXMuZ3JhcGhRTFVwZGF0ZUlucHV0Q29uZmlnKCkpO1xuICB9XG5cbiAgZ3JhcGhRTElucHV0T2JqZWN0VHlwZSgpIHtcbiAgICByZXR1cm4gbmV3IEdyYXBoUUxJbnB1dE9iamVjdFR5cGUodGhpcy5ncmFwaFFMSW5wdXRDb25maWcoKSk7XG4gIH1cblxuICBncmFwaFFMUXVlcnlJbnB1dE9iamVjdFR5cGUoKSB7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFFMSW5wdXRPYmplY3RUeXBlKHRoaXMuZ3JhcGhRTFF1ZXJ5Q29uZmlnKCkpO1xuICB9XG5cbiAgZ3JhcGhRTE9iamVjdFR5cGUoKSB7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFFMT2JqZWN0VHlwZSh0aGlzLmdyYXBoUUxDb25maWcoKSk7XG4gIH1cblxuICBnZXQoYSxiLGMpIHtcbiAgICAvKmVzbGludC1kaXNhYmxlKi9cbiAgICBjb25zb2xlLmxvZygnUGFyc2VDbGFzcyByZXNvbHZlLi4uJyk7XG4gICAgY29uc29sZS5sb2coYSxiLGMpO1xuICAgIC8qIGVzbGludC1lbmFibGUgKi9cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4iXX0=