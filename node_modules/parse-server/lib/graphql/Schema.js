'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.GraphQLParseSchema = undefined;

var _ParseClass = require('./ParseClass');

var _graphql = require('graphql');

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Flatten all graphQL selections to the dot notation.
function reduceSelections(selections) {
  return selections.reduce((memo, selection) => {
    const value = selection.name.value;
    if (selection.selectionSet === null) {
      memo.push(value);
    } else {
      // Get the sub seletions and add on current key
      const subSelections = reduceSelections(selection.selectionSet.selections);
      memo = memo.concat(subSelections.map(key => {
        return value + '.' + key;
      }));
    }
    return memo;
  }, []);
}

// Get the selections for the 1st node in a array of . separated keys
function getSelections(info) {
  const node = info.fieldNodes[0];
  return reduceSelections(node.selectionSet.selections);
}

function getQueryOptions(info) {
  const selectedKeys = getSelections(info);
  const keys = selectedKeys.join(',');
  return {
    keys,
    include: keys
  };
}

function injectClassName(className, result) {
  if (Array.isArray(result)) {
    return result.map(res => injectClassName(className, res));
  }
  return Object.assign({ className }, result);
}

function toGraphQLResult(className, singleResult) {
  return restResult => {
    const results = restResult.results;
    if (singleResult) {
      return injectClassName(className, results[0]);
    }
    return injectClassName(className, results);
  };
}

// Runs a find against the rest API
function runFind(context, info, className, where) {
  const options = getQueryOptions(info);
  return _rest2.default.find(context.config, context.auth, className, where, options).then(toGraphQLResult(className));
}

// runs a get against the rest API
function runGet(context, info, className, objectId) {
  const options = getQueryOptions(info);
  return _rest2.default.get(context.config, context.auth, className, objectId, options).then(toGraphQLResult(className, true));
}

class GraphQLParseSchema {

  constructor(schema, applicationId) {
    this.schema = schema;
    this.applicationId = applicationId;
    this.types = {};
  }

  Schema() {
    return new _graphql.GraphQLSchema({
      query: this.Query(),
      mutation: this.Mutation()
    });
  }

  Query() {
    const MainSchemaOptions = {
      name: 'ParseSchema',
      description: `The full parse schema`,
      fields: {}
    };
    Object.keys(this.schema).forEach(className => {
      const {
        queryType, objectType
      } = (0, _ParseClass.loadClass)(className, this.schema);

      MainSchemaOptions.fields[className] = {
        type: new _graphql.GraphQLList(objectType),
        description: `Use this endpoint to get or query ${className} objects`,
        args: {
          objectId: { type: _graphql.GraphQLID, name: 'objectId' },
          where: { type: queryType }
        },
        resolve: (root, args, context, info) => {
          // Get the selections
          let query = {};
          if (args.where) {
            query = Object.assign(query, args.where);
          }
          if (args.objectId) {
            query = Object.assign(query, { objectId: args.objectId });
          }
          return runFind(context, info, className, query);
        }
      };
    });
    MainSchemaOptions.fields['ParseObject'] = { type: _ParseClass.ParseObject };
    return new _graphql.GraphQLObjectType(MainSchemaOptions);
  }

  Mutation() {
    const MainSchemaMutationOptions = {
      name: 'ParseSchemaMutation',
      fields: {}
      // TODO: Refactor FunctionRouter to extract (as it's a new entry)
      // TODO: Implement Functions as mutations

    };Object.keys(this.schema).forEach(className => {
      const {
        inputType, objectType, updateType
      } = (0, _ParseClass.loadClass)(className, this.schema);

      MainSchemaMutationOptions.fields['create' + className] = {
        type: objectType,
        fields: objectType.fields,
        description: `use this method to create a new ${className}`,
        args: { input: { type: inputType } },
        name: 'create',
        resolve: (root, args, context, info) => {
          return _rest2.default.create(context.config, context.auth, className, args).then(res => {
            // Run find to match graphQL style
            return runGet(context, info, className, res.response.objectId);
          });
        }
      };

      MainSchemaMutationOptions.fields['update' + className] = {
        type: objectType,
        description: `use this method to update an existing ${className}`,
        args: {
          objectId: { type: new _graphql.GraphQLNonNull(_graphql.GraphQLID), name: 'objectId' },
          input: { type: updateType }
        },
        name: 'update',
        resolve: (root, args, context, info) => {
          const objectId = args.objectId;
          const input = args.input;
          return _rest2.default.update(context.config, context.auth, className, objectId, input).then(() => {
            // Run find to match graphQL style
            return runGet(context, info, className, objectId);
          });
        }
      };

      MainSchemaMutationOptions.fields['destroy' + className] = {
        type: objectType,
        description: `use this method to update delete an existing ${className}`,
        args: {
          objectId: { type: new _graphql.GraphQLNonNull(_graphql.GraphQLID), name: 'objectId' }
        },
        name: 'destroy',
        resolve: (root, args, context, info) => {
          return runGet(context, info, className, args.objectId).then(object => {
            return _rest2.default.del(context.config, context.auth, className, args.objectId).then(() => {
              return object;
            });
          });
        }
      };
    });
    return new _graphql.GraphQLObjectType(MainSchemaMutationOptions);
  }

  Root() {
    return Object.keys(this.schema).reduce((memo, className) => {
      memo[className] = {};
      return memo;
    }, {});
  }
}
exports.GraphQLParseSchema = GraphQLParseSchema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncmFwaHFsL1NjaGVtYS5qcyJdLCJuYW1lcyI6WyJyZWR1Y2VTZWxlY3Rpb25zIiwic2VsZWN0aW9ucyIsInJlZHVjZSIsIm1lbW8iLCJzZWxlY3Rpb24iLCJ2YWx1ZSIsIm5hbWUiLCJzZWxlY3Rpb25TZXQiLCJwdXNoIiwic3ViU2VsZWN0aW9ucyIsImNvbmNhdCIsIm1hcCIsImtleSIsImdldFNlbGVjdGlvbnMiLCJpbmZvIiwibm9kZSIsImZpZWxkTm9kZXMiLCJnZXRRdWVyeU9wdGlvbnMiLCJzZWxlY3RlZEtleXMiLCJrZXlzIiwiam9pbiIsImluY2x1ZGUiLCJpbmplY3RDbGFzc05hbWUiLCJjbGFzc05hbWUiLCJyZXN1bHQiLCJBcnJheSIsImlzQXJyYXkiLCJyZXMiLCJPYmplY3QiLCJhc3NpZ24iLCJ0b0dyYXBoUUxSZXN1bHQiLCJzaW5nbGVSZXN1bHQiLCJyZXN0UmVzdWx0IiwicmVzdWx0cyIsInJ1bkZpbmQiLCJjb250ZXh0Iiwid2hlcmUiLCJvcHRpb25zIiwicmVzdCIsImZpbmQiLCJjb25maWciLCJhdXRoIiwidGhlbiIsInJ1bkdldCIsIm9iamVjdElkIiwiZ2V0IiwiR3JhcGhRTFBhcnNlU2NoZW1hIiwiY29uc3RydWN0b3IiLCJzY2hlbWEiLCJhcHBsaWNhdGlvbklkIiwidHlwZXMiLCJTY2hlbWEiLCJHcmFwaFFMU2NoZW1hIiwicXVlcnkiLCJRdWVyeSIsIm11dGF0aW9uIiwiTXV0YXRpb24iLCJNYWluU2NoZW1hT3B0aW9ucyIsImRlc2NyaXB0aW9uIiwiZmllbGRzIiwiZm9yRWFjaCIsInF1ZXJ5VHlwZSIsIm9iamVjdFR5cGUiLCJ0eXBlIiwiR3JhcGhRTExpc3QiLCJhcmdzIiwiR3JhcGhRTElEIiwicmVzb2x2ZSIsInJvb3QiLCJQYXJzZU9iamVjdCIsIkdyYXBoUUxPYmplY3RUeXBlIiwiTWFpblNjaGVtYU11dGF0aW9uT3B0aW9ucyIsImlucHV0VHlwZSIsInVwZGF0ZVR5cGUiLCJpbnB1dCIsImNy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ImltcG9ydCB7XG4gIFBhcnNlT2JqZWN0LFxuICBsb2FkQ2xhc3MsXG59IGZyb20gJy4vUGFyc2VDbGFzcyc7XG5cbmltcG9ydCB7XG4gIEdyYXBoUUxTY2hlbWEsXG4gIEdyYXBoUUxPYmplY3RUeXBlLFxuICBHcmFwaFFMTm9uTnVsbCxcbiAgR3JhcGhRTExpc3QsXG4gIEdyYXBoUUxJRCxcbn0gZnJvbSAnZ3JhcGhxbCdcblxuaW1wb3J0IHJlc3QgZnJvbSAnLi4vcmVzdCc7XG5cbi8vIEZsYXR0ZW4gYWxsIGdyYXBoUUwgc2VsZWN0aW9ucyB0byB0aGUgZG90IG5vdGF0aW9uLlxuZnVuY3Rpb24gcmVkdWNlU2VsZWN0aW9ucyhzZWxlY3Rpb25zKSB7XG4gIHJldHVybiBzZWxlY3Rpb25zLnJlZHVjZSgobWVtbywgc2VsZWN0aW9uKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSBzZWxlY3Rpb24ubmFtZS52YWx1ZTtcbiAgICBpZiAoc2VsZWN0aW9uLnNlbGVjdGlvblNldCA9PT0gbnVsbCkge1xuICAgICAgbWVtby5wdXNoKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gR2V0IHRoZSBzdWIgc2VsZXRpb25zIGFuZCBhZGQgb24gY3VycmVudCBrZXlcbiAgICAgIGNvbnN0IHN1YlNlbGVjdGlvbnMgPSByZWR1Y2VTZWxlY3Rpb25zKHNlbGVjdGlvbi5zZWxlY3Rpb25TZXQuc2VsZWN0aW9ucyk7XG4gICAgICBtZW1vID0gbWVtby5jb25jYXQoc3ViU2VsZWN0aW9ucy5tYXAoKGtleSkgPT4ge1xuICAgICAgICByZXR1cm4gdmFsdWUgKyAnLicgKyBrZXk7XG4gICAgICB9KSk7XG4gICAgfVxuICAgIHJldHVybiBtZW1vO1xuICB9LCBbXSk7XG59XG5cbi8vIEdldCB0aGUgc2VsZWN0aW9ucyBmb3IgdGhlIDFzdCBub2RlIGluIGEgYXJyYXkgb2YgLiBzZXBhcmF0ZWQga2V5c1xuZnVuY3Rpb24gZ2V0U2VsZWN0aW9ucyhpbmZvKSB7XG4gIGNvbnN0IG5vZGUgPSBpbmZvLmZpZWxkTm9kZXNbMF07XG4gIHJldHVybiByZWR1Y2VTZWxlY3Rpb25zKG5vZGUuc2VsZWN0aW9uU2V0LnNlbGVjdGlvbnMpO1xufVxuXG5mdW5jdGlvbiBnZXRRdWVyeU9wdGlvbnMoaW5mbykge1xuICBjb25zdCBzZWxlY3RlZEtleXMgPSBnZXRTZWxlY3Rpb25zKGluZm8pO1xuICBjb25zdCBrZXlzID0gc2VsZWN0ZWRLZXlzLmpvaW4oJywnKTtcbiAgcmV0dXJuIHtcbiAgICBrZXlzLFxuICAgIGluY2x1ZGU6IGtleXNcbiAgfVxufVxuXG5mdW5jdGlvbiBpbmplY3RDbGFzc05hbWUoY2xhc3NOYW1lLCByZXN1bHQpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIHJldHVybiByZXN1bHQubWFwKChyZXMpID0+IGluamVjdENsYXNzTmFtZShjbGFzc05hbWUsIHJlcykpO1xuICB9XG4gIHJldHVybiBPYmplY3QuYXNzaWduKHtjbGFzc05hbWV9LCByZXN1bHQpO1xufVxuXG5mdW5jdGlvbiB0b0dyYXBoUUxSZXN1bHQoY2xhc3NOYW1lLCBzaW5nbGVSZXN1bHQpIHtcbiAgcmV0dXJuIChyZXN0UmVzdWx0KSA9PiB7XG4gICAgY29uc3QgcmVzdWx0cyA9IHJlc3RSZXN1bHQucmVzdWx0cztcbiAgICBpZiAoc2luZ2xlUmVzdWx0KSB7XG4gICAgICByZXR1cm4gaW5qZWN0Q2xhc3NOYW1lKGNsYXNzTmFtZSwgcmVzdWx0c1swXSk7XG4gICAgfVxuICAgIHJldHVybiBpbmplY3RDbGFzc05hbWUoY2xhc3NOYW1lLCByZXN1bHRzKTtcbiAgfVxufVxuXG4vLyBSdW5zIGEgZmluZCBhZ2FpbnN0IHRoZSByZXN0IEFQSVxuZnVuY3Rpb24gcnVuRmluZChjb250ZXh0LCBpbmZvLCBjbGFzc05hbWUsIHdoZXJlKSB7XG4gIGNvbnN0IG9wdGlvbnMgPSBnZXRRdWVyeU9wdGlvbnMoaW5mbyk7XG4gIHJldHVybiByZXN0LmZpbmQoY29udGV4dC5jb25maWcsIGNvbnRleHQuYXV0aCwgY2xhc3NOYW1lLCB3aGVyZSwgb3B0aW9ucylcbiAgICAudGhlbih0b0dyYXBoUUxSZXN1bHQoY2xhc3NOYW1lKSk7XG59XG5cbi8vIHJ1bnMgYSBnZXQgYWdhaW5zdCB0aGUgcmVzdCBBUElcbmZ1bmN0aW9uIHJ1bkdldChjb250ZXh0LCBpbmZvLCBjbGFzc05hbWUsIG9iamVjdElkKSB7XG4gIGNvbnN0IG9wdGlvbnMgPSBnZXRRdWVyeU9wdGlvbnMoaW5mbyk7XG4gIHJldHVybiByZXN0LmdldChjb250ZXh0LmNvbmZpZywgY29udGV4dC5hdXRoLCBjbGFzc05hbWUsIG9iamVjdElkLCBvcHRpb25zKVxuICAgIC50aGVuKHRvR3JhcGhRTFJlc3VsdChjbGFzc05hbWUsIHRydWUpKTtcbn1cblxuZXhwb3J0IGNsYXNzIEdyYXBoUUxQYXJzZVNjaGVtYSB7XG4gIHNjaGVtYTtcbiAgdHlwZXM7XG4gIGFwcGxpY2F0aW9uSWQ7XG5cbiAgY29uc3RydWN0b3Ioc2NoZW1hLCBhcHBsaWNhdGlvbklkKSB7XG4gICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7XG4gICAgdGhpcy5hcHBsaWNhdGlvbklkID0gYXBwbGljYXRpb25JZDtcbiAgICB0aGlzLnR5cGVzID0ge307XG4gIH1cblxuICBTY2hlbWEoKSB7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFFMU2NoZW1hKHtcbiAgICAgIHF1ZXJ5OiB0aGlzLlF1ZXJ5KCksXG4gICAgICBtdXRhdGlvbjogdGhpcy5NdXRhdGlvbigpLFxuICAgIH0pO1xuICB9XG5cbiAgUXVlcnkoKSB7XG4gICAgY29uc3QgTWFpblNjaGVtYU9wdGlvbnMgPSB7XG4gICAgICBuYW1lOiAnUGFyc2VTY2hlbWEnLFxuICAgICAgZGVzY3JpcHRpb246IGBUaGUgZnVsbCBwYXJzZSBzY2hlbWFgLFxuICAgICAgZmllbGRzOiB7fVxuICAgIH1cbiAgICBPYmplY3Qua2V5cyh0aGlzLnNjaGVtYSkuZm9yRWFjaCgoY2xhc3NOYW1lKSA9PiB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHF1ZXJ5VHlwZSwgb2JqZWN0VHlwZVxuICAgICAgfSA9IGxvYWRDbGFzcyhjbGFzc05hbWUsIHRoaXMuc2NoZW1hKTtcblxuICAgICAgTWFpblNjaGVtYU9wdGlvbnMuZmllbGRzW2NsYXNzTmFtZV0gPSB7XG4gICAgICAgIHR5cGU6IG5ldyBHcmFwaFFMTGlzdChvYmplY3RUeXBlKSxcbiAgICAgICAgZGVzY3JpcHRpb246IGBVc2UgdGhpcyBlbmRwb2ludCB0byBnZXQgb3IgcXVlcnkgJHtjbGFzc05hbWV9IG9iamVjdHNgLFxuICAgICAgICBhcmdzOiB7XG4gICAgICAgICAgb2JqZWN0SWQ6IHsgdHlwZTogR3JhcGhRTElELCBuYW1lOiAnb2JqZWN0SWQnIH0sXG4gICAgICAgICAgd2hlcmU6IHsgdHlwZTogcXVlcnlUeXBlIH1cbiAgICAgICAgfSxcbiAgICAgICAgcmVzb2x2ZTogKHJvb3QsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IHtcbiAgICAgICAgICAvLyBHZXQgdGhlIHNlbGVjdGlvbnNcbiAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcbiAgICAgICAgICBpZiAoYXJncy53aGVyZSkge1xuICAgICAgICAgICAgcXVlcnkgPSBPYmplY3QuYXNzaWduKHF1ZXJ5LCBhcmdzLndoZXJlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFyZ3Mub2JqZWN0SWQpIHtcbiAgICAgICAgICAgIHF1ZXJ5ID0gT2JqZWN0LmFzc2lnbihxdWVyeSwgeyBvYmplY3RJZDogYXJncy5vYmplY3RJZCB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJ1bkZpbmQoY29udGV4dCwgaW5mbywgY2xhc3NOYW1lLCBxdWVyeSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSk7XG4gICAgTWFpblNjaGVtYU9wdGlvbnMuZmllbGRzWydQYXJzZU9iamVjdCddID0geyB0eXBlOiBQYXJzZU9iamVjdCB9O1xuICAgIHJldHVybiBuZXcgR3JhcGhRTE9iamVjdFR5cGUoTWFpblNjaGVtYU9wdGlvbnMpO1xuICB9XG5cbiAgTXV0YXRpb24oKSAge1xuICAgIGNvbnN0IE1haW5TY2hlbWFNdXRhdGlvbk9wdGlvbnMgPSB7XG4gICAgICBuYW1lOiAnUGFyc2VTY2hlbWFNdXRhdGlvbicsXG4gICAgICBmaWVsZHM6IHt9XG4gICAgfVxuICAgIC8vIFRPRE86IFJlZmFjdG9yIEZ1bmN0aW9uUm91dGVyIHRvIGV4dHJhY3QgKGFzIGl0J3MgYSBuZXcgZW50cnkpXG4gICAgLy8gVE9ETzogSW1wbGVtZW50IEZ1bmN0aW9ucyBhcyBtdXRhdGlvbnNcblxuICAgIE9iamVjdC5rZXlzKHRoaXMuc2NoZW1hKS5mb3JFYWNoKChjbGFzc05hbWUpID0+IHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgaW5wdXRUeXBlLCBvYmplY3RUeXBlLCB1cGRhdGVUeXBlXG4gICAgICB9ID0gbG9hZENsYXNzKGNsYXNzTmFtZSwgdGhpcy5zY2hlbWEpO1xuXG4gICAgICBNYWluU2NoZW1hTXV0YXRpb25PcHRpb25zLmZpZWxkc1snY3JlYXRlJyArIGNsYXNzTmFtZV0gPSB7XG4gICAgICAgIHR5cGU6IG9iamVjdFR5cGUsXG4gICAgICAgIGZpZWxkczogb2JqZWN0VHlwZS5maWVsZHMsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgdXNlIHRoaXMgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyAke2NsYXNzTmFtZX1gLFxuICAgICAgICBhcmdzOiB7IGlucHV0OiB7IHR5cGU6IGlucHV0VHlwZSB9fSxcbiAgICAgICAgbmFtZTogJ2NyZWF0ZScsXG4gICAgICAgIHJlc29sdmU6IChyb290LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHJlc3QuY3JlYXRlKGNvbnRleHQuY29uZmlnLCBjb250ZXh0LmF1dGgsIGNsYXNzTmFtZSwgYXJncykudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICAvLyBSdW4gZmluZCB0byBtYXRjaCBncmFwaFFMIHN0eWxlXG4gICAgICAgICAgICByZXR1cm4gcnVuR2V0KGNvbnRleHQsIGluZm8sIGNsYXNzTmFtZSwgcmVzLnJlc3BvbnNlLm9iamVjdElkKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBNYWluU2NoZW1hTXV0YXRpb25PcHRpb25zLmZpZWxkc1sndXBkYXRlJyArIGNsYXNzTmFtZV0gPSB7XG4gICAgICAgIHR5cGU6IG9iamVjdFR5cGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgdXNlIHRoaXMgbWV0aG9kIHRvIHVwZGF0ZSBhbiBleGlzdGluZyAke2NsYXNzTmFtZX1gLFxuICAgICAgICBhcmdzOiB7XG4gICAgICAgICAgb2JqZWN0SWQ6IHsgdHlwZTogbmV3IEdyYXBoUUxOb25OdWxsKEdyYXBoUUxJRCksIG5hbWU6ICdvYmplY3RJZCcgfSxcbiAgICAgICAgICBpbnB1dDogeyB0eXBlOiB1cGRhdGVUeXBlIH1cbiAgICAgICAgfSxcbiAgICAgICAgbmFtZTogJ3VwZGF0ZScsXG4gICAgICAgIHJlc29sdmU6IChyb290LCBhcmdzLCBjb250ZXh0LCBpbmZvKSA9PiB7XG4gICAgICAgICAgY29uc3Qgb2JqZWN0SWQgPSBhcmdzLm9iamVjdElkO1xuICAgICAgICAgIGNvbnN0IGlucHV0ID0gYXJncy5pbnB1dDtcbiAgICAgICAgICByZXR1cm4gcmVzdC51cGRhdGUoY29udGV4dC5jb25maWcsIGNvbnRleHQuYXV0aCwgY2xhc3NOYW1lLCBvYmplY3RJZCwgaW5wdXQpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gUnVuIGZpbmQgdG8gbWF0Y2ggZ3JhcGhRTCBzdHlsZVxuICAgICAgICAgICAgcmV0dXJuIHJ1bkdldChjb250ZXh0LCBpbmZvLCBjbGFzc05hbWUsIG9iamVjdElkKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBNYWluU2NoZW1hTXV0YXRpb25PcHRpb25zLmZpZWxkc1snZGVzdHJveScgKyBjbGFzc05hbWVdID0ge1xuICAgICAgICB0eXBlOiBvYmplY3RUeXBlLFxuICAgICAgICBkZXNjcmlwdGlvbjogYHVzZSB0aGlzIG1ldGhvZCB0byB1cGRhdGUgZGVsZXRlIGFuIGV4aXN0aW5nICR7Y2xhc3NOYW1lfWAsXG4gICAgICAgIGFyZ3M6IHtcbiAgICAgICAgICBvYmplY3RJZDogeyB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoR3JhcGhRTElEKSwgbmFtZTogJ29iamVjdElkJyB9XG4gICAgICAgIH0sXG4gICAgICAgIG5hbWU6ICdkZXN0cm95JyxcbiAgICAgICAgcmVzb2x2ZTogKHJvb3QsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+IHtcbiAgICAgICAgICByZXR1cm4gcnVuR2V0KGNvbnRleHQsIGluZm8sIGNsYXNzTmFtZSwgYXJncy5vYmplY3RJZCkudGhlbigob2JqZWN0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdC5kZWwoY29udGV4dC5jb25maWcsIGNvbnRleHQuYXV0aCwgY2xhc3NOYW1lLCBhcmdzLm9iamVjdElkKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBHcmFwaFFMT2JqZWN0VHlwZShNYWluU2NoZW1hTXV0YXRpb25PcHRpb25zKTtcbiAgfVxuXG4gIFJvb3QoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuc2NoZW1hKS5yZWR1Y2UoKG1lbW8sIGNsYXNzTmFtZSkgPT4ge1xuICAgICAgbWVtb1tjbGFzc05hbWVdID0ge31cbiAgICAgIHJldHVybiBtZW1vO1xuICAgIH0sIHt9KTtcbiAgfVxufVxuIl19